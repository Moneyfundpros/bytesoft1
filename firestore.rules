rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // COORDINATOR DATA OPTIMIZATION GUIDE
    // ============================================================================
    // To support efficient pagination and filtering, create these Firestore indexes:
    //
    // 1. ENROLLMENTS PAGINATION INDEX (REQUIRED)
    //    Collection: enrollments
    //    Fields: teacherId (Ascending), enrolledAt (Descending)
    //    Deploy: firebase firestore:indexes:create
    //
    // 2. REVIEWS SORTING INDEX (REQUIRED)
    //    Collection: teacher_reviews  
    //    Fields: teacherId (Ascending), createdAt (Descending)
    //    Deploy: firebase firestore:indexes:create
    //
    // 3. STUDENTS VERIFICATION FILTER INDEX (OPTIONAL but recommended)
    //    Collection: enrollments
    //    Fields: teacherId (Ascending), verified (Ascending)
    //    For efficient filtering by verification status
    //
    // VIEW CURRENT INDEXES:
    //    firebase firestore:indexes:list
    //
    // ============================================================================
    // COORDINATOR FIELD RESTRICTIONS
    // ============================================================================
    // Coordinators should NOT read sensitive fields:
    // - bankAccount (payment details)
    // - verificationType (Paystack verification data)
    // - passwordHash (NEVER readable)
    // - ssn/government ID (personal data)
    //
    // OPTIMIZATION TIP: For large platforms, exclude these fields from
    // coordinator queries by using field projection in Firestore SDK v9+:
    //   const userRef = doc(db, 'users', teacherId);
    //   const data = await getDoc(query(collection(db, 'users'), where('id','==',teacherId)));
    //   // Return only: name, email, profilePicture, classesHeld, isVerified, createdAt
    //
    // ============================================================================

    // IMPORTANT: Admin Verification
    // For admins to function properly, ensure:
    // 1. An admin document exists at /admins/{adminUID} with {role: 'admin'}
    // 2. OR the user document at /users/{adminUID} has {role: 'admin'}
    // Without this, all admin operations (delete, manage accounts) will fail with "permission-denied"

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && (
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
    }

    function isCoordinator() {
      return isAuthenticated() && (
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'coordinator') ||
        isAdmin()
      );
    }

    function isTeacher() {
      return isAuthenticated() && (
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher') ||
        isAdmin()
      );
    }

    function isStudent() {
      return isAuthenticated() && (
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student'
      );
    }

    // Users collection
    match /users/{userId} {
      // Students can only read their own data (non-verification fields)
      allow read: if isStudent() && isOwner(userId);
      
      // Coordinators can read all users
      // Can see: email, name, role, profilePicture, username, classesHeld, createdAt, customUserId
      // Cannot see: verification fields, debit accounts, sensitive data
      allow read: if isCoordinator() && (
        request.resource == null || // Allow read on any user document
        true
      );
      
      // Teachers can read other teachers (for viewing profiles)
      allow read: if isTeacher() &&
        get(/databases/$(database)/documents/users/$(userId)).data.role == 'teacher';
      
      // Admin can read all
      allow read: if isAdmin();

      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Students can only update their own non-sensitive fields
      // Explicitly prevent any modification of verification-related fields
      allow update: if isOwner(userId) && (
        request.resource.data.keys().hasOnly(['fullName', 'username', 'profilePicture', 'debitAccount', 'email', 'name', 'role', 'customUserId', 'createdAt']) &&
        !('isVerified' in request.resource.data.keys()) &&
        !('verified' in request.resource.data.keys()) &&
        !('verificationType' in request.resource.data.keys()) &&
        !('purchasedCourses' in request.resource.data.keys()) &&
        !('verifiedBy' in request.resource.data.keys()) &&
        !('verifiedAt' in request.resource.data.keys()) &&
        !('classesHeld' in request.resource.data.keys())
      );

      // Teachers can update their own classesHeld field (auto-updated from admin/teacher dashboard)
      allow update: if isOwner(userId) && isTeacher() && (
        request.resource.data.keys().hasOnly(['classesHeld']) ||
        (request.resource.data.keys().hasOnly(['fullName', 'username', 'profilePicture', 'debitAccount', 'email', 'name', 'role', 'customUserId', 'createdAt', 'classesHeld']) &&
         !('isVerified' in request.resource.data.keys()))
      );

      // Coordinators can update teachers' classesHeld field for manual corrections
      // IMPORTANT: Coordinators CANNOT modify verification fields, bank accounts, or other sensitive data
      allow update: if isCoordinator() && 
        get(/databases/$(database)/documents/users/$(userId)).data.role == 'teacher' &&
        (request.resource.data.keys().hasOnly(['classesHeld']) ||
         request.resource.data.keys().hasOnly(['classesHeld', 'email', 'name', 'role', 'customUserId', 'createdAt', 'fullName', 'username', 'profilePicture', 'debitAccount']));

      // Coordinators can update students' purchasedCourses and verificationType for manual verification
      // CRITICAL PROTECTION: Cannot change verificationType from 'paystack' to anything else
      // This prevents accidental or malicious overwrite of Paystack verification
      // IMPORTANT: Coordinators have limited update access - only for verification and course access
      allow update: if isCoordinator() && (
        request.resource.data.keys().hasOnly([
          'purchasedCourses', 'isVerified', 'verified', 'verificationType',
          'verifiedBy', 'verifiedAt', 'email', 'name', 'role', 'customUserId',
          'createdAt', 'fullName', 'username', 'profilePicture', 'debitAccount'
        ])
      ) && (
        // CRITICAL: If existing user has paystack verificationType, reject any update
        // This makes Paystack verification immutable
        (!('verificationType' in resource.data) || resource.data.verificationType != 'paystack') &&
        // Allow creation of manual verification only if not already verified via paystack
        (request.resource.data.verificationType == 'manual' &&
         (!('verificationType' in resource.data) || resource.data.verificationType != 'paystack'))
      );

      allow delete: if isOwner(userId) || isAdmin();
    }

    // Helper: check if authenticated user is enrolled in a course
    // NOTE: This check assumes enrollment documents use the id pattern: "{studentUid}_{courseId}"
    // When creating enrollments from the client, enforce this id scheme for proper rule checks.
    function isEnrolled(courseId) {
      return isAuthenticated() && exists(/databases/$(database)/documents/enrollments/$(request.auth.uid + '_' + courseId));
    }

    // Courses collection
    match /courses/{courseId} {
      allow read: if isAuthenticated();
      allow create, update: if isCoordinator();
      allow delete: if isAdmin() || (isTeacher() && resource.data.instructorId == request.auth.uid);
    }

    // Scheme of Work subcollection under courses: /courses/{courseId}/scheme/{itemId}
    match /courses/{courseId}/scheme/{itemId} {
      // Creation: only the teacher assigned to this course may create scheme items
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid && request.resource.data.courseId == courseId && (
        // verify teacher owns the course
        get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid
      );

      // Read: teachers assigned to course, coordinators, admins, or enrolled students
      allow read: if isAuthenticated() && (
        (isTeacher() && get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid)
        || isCoordinator() || isAdmin()
        || isEnrolled(courseId)
      );

      // Update/Delete: only the creating teacher or admin
      allow update, delete: if isTeacher() && resource.data.teacherId == request.auth.uid || isAdmin();
    }

    // Enrollments collection
    match /enrollments/{enrollmentId} {
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        isCoordinator() ||
        isTeacher() ||
        isStudent()
      );
      allow create: if isAuthenticated();
      allow update: if isCoordinator();
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.studentId == request.auth.uid);
    }

    // Scheduled Classes collection (snake_case version)
    match /scheduled_classes/{classId} {
      allow read: if isAuthenticated();
      allow create, update: if isTeacher() || isCoordinator();
      allow delete: if isAdmin() || (isTeacher() && resource.data.teacherId == request.auth.uid);
    }

    // Class Attendance collection (snake_case version)
    match /class_attendance/{attendanceId} {
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        isTeacher() ||
        isCoordinator()
      );
      allow create, update: if isTeacher() || isCoordinator();
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.studentId == request.auth.uid);
    }

    // Grades collection
    match /grades/{gradeId} {
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        isCoordinator() ||
        isTeacher()
      );
      allow create, update: if isTeacher() || isCoordinator();
      allow delete: if isAdmin();
    }

    // Assignments collection
    match /assignments/{assignmentId} {
      allow read: if isAuthenticated();
      allow create, update: if isTeacher() || isCoordinator();
      allow delete: if isAdmin();
    }

    // Submissions collection
    match /submissions/{submissionId} {
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        isTeacher() ||
        isCoordinator()
      );
      allow create: if isAuthenticated() && request.resource.data.studentId == request.auth.uid;
      allow update: if isOwner(resource.data.studentId) || isTeacher() || isCoordinator();
      allow delete: if isAdmin();
    }

    // Teacher Reviews collection
    match /teacher_reviews/{reviewId} {
      // Students can read reviews (for transparency)
      allow read: if isStudent();
      // Teachers can read reviews of themselves
      allow read: if isTeacher() && resource.data.teacherId == request.auth.uid;
      // Coordinators and admins can read all reviews
      allow read: if isCoordinator() || isAdmin();
      // Students can create reviews
      allow create: if isStudent() && request.resource.data.reviewerType == 'student' && request.resource.data.studentId == request.auth.uid;
      // Coordinators can create reviews
      allow create: if isCoordinator() && request.resource.data.reviewerType == 'coordinator' && request.resource.data.coordinatorId == request.auth.uid;
      // Only admins can update or delete reviews
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Admin collection
    match /admins/{adminId} {
      allow read: if isAuthenticated() && request.auth.uid == adminId;
      allow write: if false;
    }

    // Access Codes collection
    match /accessCodes/{codeId} {
      // Allow anyone to read codes (needed for validation during signup)
      allow read: if true;
      allow create, delete: if isAdmin();
      // Allow users to mark codes as used during signup (changing status from 'unused' to 'used')
      allow update: if isAdmin() ||
                     (isAuthenticated() &&
                      resource.data.status == 'unused' &&
                      request.resource.data.status == 'used' &&
                      request.resource.data.usedBy == request.auth.uid);
    }

    // Used Custom IDs collection (tracks all used custom IDs for uniqueness checking)
    match /usedCustomIds/{idDoc} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    // User Accounts collection
    match /userAccounts/{accountId} {
      allow read: if isAuthenticated();
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
    }

    // User Roles collection
    match /userRoles/{roleId} {
      allow read: if isAuthenticated();
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
    }

    // Audit Logs collection
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }

    // Scheduled Classes collection (fix typo from previous rules)
    match /scheduledClasses/{classId} {
      allow read: if isAuthenticated();
      allow create, update: if isTeacher() || isCoordinator();
      allow delete: if isAdmin() || (isTeacher() && resource.data.teacherId == request.auth.uid);
    }

    // Class Attendance collection (fix typo from previous rules)
    match /classAttendance/{attendanceId} {
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        isTeacher() ||
        isCoordinator()
      );
      allow create, update: if isTeacher() || isCoordinator();
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.studentId == request.auth.uid);
    }

    // Meetings collection
    match /meetings/{meetingId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (isTeacher() || isAdmin());
      allow update: if isAuthenticated() && (
        resource.data.teacherId == request.auth.uid ||
        isTeacher() ||
        isCoordinator()
      );
      allow delete: if isAdmin() || isCoordinator() || (isTeacher() && resource.data.teacherId == request.auth.uid);
    }

    // Course Requests collection
    match /course_requests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.teacherId == request.auth.uid ||
        isCoordinator() ||
        isAdmin()
      );
      allow create: if isAuthenticated() && isTeacher() &&
        request.resource.data.teacherId == request.auth.uid;
      allow update: if isAuthenticated() && (
        isCoordinator() || isAdmin()
      );
      allow delete: if isAdmin() || (isTeacher() && resource.data.teacherId == request.auth.uid);
    }

    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (
        resource.data.teacherId == request.auth.uid ||
        isCoordinator() ||
        isAdmin()
      );
      allow create: if isAuthenticated() && (
        isCoordinator() || isAdmin()
      );
      allow update: if isAuthenticated() && (
        resource.data.teacherId == request.auth.uid ||
        isCoordinator() ||
        isAdmin()
      );
      allow delete: if isAdmin() || (isTeacher() && resource.data.teacherId == request.auth.uid);
    }

    // Activity Logs collection
    match /activityLogs/{logId} {
      allow read: if isAuthenticated() && (
        isCoordinator() || isAdmin()
      );
      allow create: if isAuthenticated() && (
        isCoordinator() || isAdmin()
      );
      allow update, delete: if false;
    }

    // Teacher Reviews collection
    match /teacher_reviews/{reviewId} {
      // Coordinators and admins can read all reviews
      allow read: if isCoordinator() || isAdmin();
      // Teachers can read reviews about themselves
      allow read: if isTeacher() && resource.data.teacherId == request.auth.uid;
      // Students can read reviews (filtered by UI to show only published reviews)
      allow read: if isStudent();

      // Only coordinators can create coordinator reviews
      allow create: if isAuthenticated() && (
        (isCoordinator() && request.resource.data.coordinatorId == request.auth.uid && request.resource.data.reviewerType == 'coordinator') ||
        (isStudent() && request.resource.data.studentId == request.auth.uid && request.resource.data.reviewerType == 'student')
      );

      allow update: if isAdmin();
      allow delete: if isAdmin() ||
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        (isCoordinator() && resource.data.coordinatorId == request.auth.uid) ||
        (isTeacher() && resource.data.teacherId == request.auth.uid);
    }

    // Payments collection
    // Payments are created for course enrollments. Documents are typically
    // created by server-side functions (admin SDK) but we also allow authenticated
    // users to create a payment record (client-side) as long as the `userId`
    // field matches request.auth.uid and required fields are present.
    match /payments/{paymentId} {
      // Allow coordinators and admins to read all payments; owners can read their own
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        isCoordinator() || isAdmin()
      );

      // Allow authenticated user to create a payment document (server-generated id or client id)
      // Require: userId == request.auth.uid, courseId string, amount number, reference string, status string
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        (request.resource.data.courseId is string) &&
        (request.resource.data.amount is number) &&
        (request.resource.data.reference is string) &&
        (request.resource.data.status is string) &&
        request.resource.data.email == request.auth.token.email;

      // Allow owner or admin to update their payment document (use cautiously)
      allow update: if isAuthenticated() && (request.resource.data.userId == request.auth.uid || isAdmin());

      // Deletes only by admin
      allow delete: if isAdmin();
    }

    // Courses subcollections for students and subcollections for enrollments
    match /courses/{courseId}/students/{userId} {
      // Users can read their own enrollment in courses
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Teachers and coordinators can read all student enrollments in courses
      allow read: if isTeacher() || isCoordinator() || isAdmin();
      // Only authenticated users can create (via Cloud Function)
      allow create: if false;
      allow delete: if isAdmin();
    }

    // Course teachers subcollection
    match /courses/{courseId}/teachers/{teacherId} {
      // Coordinators and admins can read all teachers assigned to a course
      allow read: if isCoordinator() || isAdmin();
      // Teachers can read themselves on a course
      allow read: if isTeacher() && request.auth.uid == teacherId;
      allow create, update: if isCoordinator() || isAdmin();
      allow delete: if isAdmin();
    }

    // Course reviews subcollection (student reviews about the course)
    match /courses/{courseId}/reviews/{reviewId} {
      // Coordinators and admins can read all reviews
      allow read: if isCoordinator() || isAdmin();
      // Students can read reviews (for transparency)
      allow read: if isStudent();
      // Only coordinators can create and update
      allow create: if isCoordinator() || isAdmin();
      allow update: if isCoordinator() || isAdmin();
      allow delete: if isAdmin();
    }

    // Course sessions subcollection (classes held)
    match /courses/{courseId}/sessions/{sessionId} {
      // Coordinators, teachers, and admins can read sessions
      allow read: if isCoordinator() || isTeacher() || isAdmin();
      // Teachers and coordinators can create and update
      allow create, update: if isTeacher() || isCoordinator() || isAdmin();
      allow delete: if isAdmin();
    }

    match /users/{userId}/enrollments/{courseId} {
      // Users can read their own enrollments
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Only authenticated users can create (via Cloud Function)
      allow create: if false;
      allow delete: if isAdmin();
    }

    // Received Links subcollection for students
    match /users/{userId}/receivedLinks/{linkId} {
      // Students can read their own received links
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Coordinators and admins can read all received links for oversight
      allow read: if isCoordinator() || isAdmin();
      // Teachers can create links for students
      allow create: if isAuthenticated() && isTeacher();
      // Allow updates by admins only
      allow update: if isAdmin();
      // Students can delete their own links
      allow delete: if isAuthenticated() && request.auth.uid == userId || isAdmin();
    }

    // CBT Questions - teachers manage questions for their courses. Students may read questions
    // during active exams; for production consider serving exam question payloads via
    // Cloud Functions to prevent exposing `correctAnswer` fields prematurely.
    match /cbt_questions/{questionId} {
      allow read: if isAuthenticated() && (
        // Teachers may read their own questions
        (isTeacher() && get(/databases/$(database)/documents/cbt_questions/$(questionId)).data.teacherId == request.auth.uid) ||
        // Coordinators and admins may read all
        isCoordinator() || isAdmin() ||
        // Students may read questions when they are allowed by the client (UI gating)
        isStudent()
      );
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid || isCoordinator() || isAdmin();
      allow update: if (isTeacher() && resource.data.teacherId == request.auth.uid) || isCoordinator() || isAdmin();
      allow delete: if (isTeacher() && resource.data.teacherId == request.auth.uid) || isAdmin();
    }

    // CBT Exams - exams metadata and scheduling
    match /cbt_exams/{examId} {
      allow read: if isAuthenticated() && (
        // Coordinators, admins and course teachers can read
        isCoordinator() || isAdmin() || (isTeacher() && resource.data.teacherId == request.auth.uid) ||
        // Students may read only if enrolled in the course this exam belongs to
        (isStudent() && isEnrolled(resource.data.courseId))
      );
      // Creation: only teacher assigned to the course (teacherId must match auth.uid) or coordinator/admin
      allow create: if (isTeacher() && request.resource.data.teacherId == request.auth.uid && request.resource.data.courseId is string) || isCoordinator() || isAdmin();
      // Updates: only the creating teacher may update (teacherId == resource.teacherId), or coordinators/admins
      // Prevent updates once an exam is published (only admins may modify published exams)
      allow update: if isAdmin() || (
        ( (isTeacher() && resource.data.teacherId == request.auth.uid) || isCoordinator() )
        && (resource.data.status != 'published')
      );
      allow delete: if (isAdmin() || (isTeacher() && resource.data.teacherId == request.auth.uid));
    }

    // Exam Attempts - students submit attempts; teachers and coordinators can read attempts in their courses
    match /exam_attempts/{attemptId} {
      allow read: if isAuthenticated() && (
        // Student owner can read
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        // Teachers and coordinators can read attempts to grade/review
        isTeacher() || isCoordinator() || isAdmin()
      );
      // Students may create their own attempts
      allow create: if isStudent() && request.resource.data.studentId == request.auth.uid && request.resource.data.courseId is string;
      // Teachers/coordinator/cloud functions may update score/status
      allow update: if isTeacher() || isCoordinator() || isAdmin();
      allow delete: if isAdmin();
    }

    // Practice mode attempts: stored under practiceAttempts/{userId}/attempts/{attemptId}
    match /practiceAttempts/{userId}/attempts/{attemptId} {
      // Only the owner (student) may create/read/update/delete their practice attempts
      allow create: if request.auth != null && request.auth.uid == userId && request.resource.data.studentId == userId;
      allow read: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
    }

    // AI API Keys - only coordinators may create/update their own API keys
    // IMPORTANT: For production, store API keys via a server-side Cloud Function with KMS encryption
    // Allow coordinators to store the system AI key at /settings/aiKey
    match /settings/aiKey {
      allow read: if isAuthenticated() && (isCoordinator() || isAdmin());
      allow create, update: if isCoordinator() && request.auth.uid == request.resource.data.coordinatorId;
      allow delete: if isAdmin() || (isCoordinator() && resource.data.coordinatorId == request.auth.uid);
    }

    match /ai_api_keys/{keyId} {
      allow read: if isAuthenticated() && (
        (isCoordinator() && get(/databases/$(database)/documents/ai_api_keys/$(keyId)).data.coordinatorId == request.auth.uid) ||
        isAdmin()
      );
      allow create: if isCoordinator() && request.resource.data.coordinatorId == request.auth.uid;
      allow update: if isCoordinator() && get(/databases/$(database)/documents/ai_api_keys/$(keyId)).data.coordinatorId == request.auth.uid;
      allow delete: if isAdmin() || (isCoordinator() && resource.data.coordinatorId == request.auth.uid);
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
